<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Voting App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 500px;
            width: 95%;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .vote-button {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .vote-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .vote-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div id="header-section" class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Project Poll</h1>
        <p class="text-gray-500">Vote for your favorite option.</p>
    </div>

    <!-- Main Content Area -->
    <div id="main-content">
        <!-- Initial Login Screen -->
        <div id="login-screen" class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">Enter Your Voting ID</h2>
            <input id="voting-id-input" type="text" placeholder="e.g., U1234 or Admin Code"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button id="login-button"
                    class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 vote-button">
                Login / Start Voting
            </button>
            <p id="error-message" class="text-sm text-red-600 hidden mt-2"></p>

            <!-- Admin Hint for Offline Mode -->
            <div id="admin-hint" class="mt-6 p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm text-center">
                <p class="font-semibold">Deployment Tip:</p>
                <p>On static hosts (like GitHub Pages), use the **Admin Code: 6969** to view the results dashboard structure.</p>
            </div>
        </div>

        <!-- Voting Screen -->
        <div id="voting-screen" class="space-y-6 hidden">
            <h2 class="text-xl font-semibold text-gray-700">Voting as: <span id="current-user-id" class="text-blue-600"></span></h2>
            <div id="candidates-list" class="space-y-3">
                <!-- Candidates will be inserted here -->
            </div>
            <p id="vote-status" class="text-center text-green-600 font-medium hidden"></p>
            <button id="logout-button"
                    class="w-full bg-gray-400 text-white p-3 rounded-lg font-bold hover:bg-gray-500 vote-button mt-4">
                Logout
            </button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="space-y-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Live Results Dashboard</h2>
            <p id="results-status" class="text-center text-sm font-medium"></p>
            <div id="results-charts" class="space-y-4">
                <!-- Results will be inserted here -->
            </div>
            <button id="results-logout-button"
                    class="w-full bg-red-600 text-white p-3 rounded-lg font-bold hover:bg-red-700 vote-button mt-4">
                Logout
            </button>
        </div>
    </div>
</div>

<script type="module">
    // IMPORTANT: THESE GLOBAL VARIABLES ARE PROVIDED BY THE CANVAS ENVIRONMENT
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, query, setDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Core State and Configuration ---
    let db = null;
    let auth = null;
    let userId = null;
    let isAuthReady = false;
    let candidates = [
        { id: 'candidateA', name: 'Project Alpha' },
        { id: 'candidateB', name: 'Project Beta' },
        { id: 'candidateC', name: 'Project Gamma' }
    ];
    
    // Check if the environment provides valid Firebase configuration (online check)
    const isOnlineMode = (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5);
    const ADMIN_CODE = '6969'; // Hardcoded Admin Code for results view

    // --- DOM Elements ---
    const loginScreen = document.getElementById('login-screen');
    const votingScreen = document.getElementById('voting-screen');
    const resultsScreen = document.getElementById('results-screen');
    const votingIdInput = document.getElementById('voting-id-input');
    const loginButton = document.getElementById('login-button');
    const errorMessage = document.getElementById('error-message');
    const candidatesList = document.getElementById('candidates-list');
    const voteStatus = document.getElementById('vote-status');
    const currentUserIdSpan = document.getElementById('current-user-id');
    const resultsStatus = document.getElementById('results-status');
    const resultsCharts = document.getElementById('results-charts');
    const logoutButton = document.getElementById('logout-button');
    const resultsLogoutButton = document.getElementById('results-logout-button');
    const adminHint = document.getElementById('admin-hint');


    // --- Helper Functions ---

    /**
     * Initializes Firebase and authenticates the user.
     */
    async function initFirebase() {
        if (!isOnlineMode) {
            // If offline, the login screen will be visible and display the error message.
            displayOfflineMode();
            return;
        }

        try {
            // setLogLevel('debug'); // Uncomment to see Firebase logs
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Handle Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authenticated with UID:", userId);
                } else {
                    // Sign in if a custom token is available, otherwise sign in anonymously.
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Authentication failed:", e);
                        displayError("Authentication failed. Please try again.");
                    }
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            displayError("A critical error occurred during initialization. Check console for details.");
        }
    }

    /**
     * Displays a generic error message or the error passed in.
     */
    function displayError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    /**
     * Renders the login/offline screen.
     */
    function displayOfflineMode() {
        loginScreen.classList.remove('hidden');
        votingScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        
        // Custom message for offline mode
        displayError(`Database connection error. Voting is disabled. (Offline Mode)`);
        adminHint.classList.remove('hidden');

        // Allow login button to trigger the check/admin bypass
        loginButton.onclick = handleLogin;
    }

    /**
     * Handles the login button click.
     */
    async function handleLogin() {
        const inputId = votingIdInput.value.trim();
        errorMessage.classList.add('hidden');

        if (!inputId) {
            displayError("Please enter a Voting ID or the Admin Code.");
            return;
        }

        if (inputId === ADMIN_CODE) {
            // ADMIN PATH: Bypass online check and show results screen structure
            userId = 'ADMIN_VIEWER';
            adminHint.classList.add('hidden');
            renderView('results');
            return;
        }

        if (!isOnlineMode) {
            // Cannot proceed if not in Online Mode unless it's the Admin Code
            displayOfflineMode();
            return;
        }

        // Standard User Login (Online Mode only)
        try {
            // In a real application, this would trigger server-side auth or use the UID
            // For this environment, we rely on the initial sign-in from initFirebase
            if (isAuthReady) {
                // We use the authenticated user's ID, but you could generate one here
                // For simplicity, we just move to the voting screen now.
                renderView('voting');
            } else {
                displayError("Still authenticating. Please wait a moment and try again.");
            }

        } catch (e) {
            console.error("Login failed:", e);
            displayError("Login failed. Check your ID and network connection.");
        }
    }

    /**
     * Renders the current application view (login, voting, or results).
     */
    function renderView(view) {
        loginScreen.classList.add('hidden');
        votingScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        errorMessage.classList.add('hidden');
        adminHint.classList.add('hidden');
        
        if (view === 'voting') {
            currentUserIdSpan.textContent = votingIdInput.value.trim() || userId;
            renderCandidates();
            votingScreen.classList.remove('hidden');
            if (isOnlineMode) {
                // If online, listen for if the user has already voted
                listenForUserVote(votingIdInput.value.trim() || userId);
            } else {
                voteStatus.textContent = "Cannot submit votes in Offline Mode.";
                voteStatus.classList.remove('hidden');
                // Disable all voting buttons
                document.querySelectorAll('.vote-button-candidate').forEach(btn => btn.disabled = true);
            }
        } else if (view === 'results') {
            resultsScreen.classList.remove('hidden');
            if (isOnlineMode) {
                resultsStatus.textContent = "Loading live results...";
                listenForResults();
            } else {
                resultsStatus.textContent = "Database is OFFLINE. Live results cannot be loaded. Showing structure only.";
                renderOfflineResults();
            }
        } else {
            votingIdInput.value = '';
            loginScreen.classList.remove('hidden');
            if (!isOnlineMode) displayOfflineMode();
        }
    }

    /**
     * Renders the list of candidates with vote buttons.
     */
    function renderCandidates() {
        candidatesList.innerHTML = '';
        candidates.forEach(candidate => {
            const button = document.createElement('button');
            button.className = 'w-full bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600 vote-button vote-button-candidate';
            button.textContent = `Vote for ${candidate.name}`;
            button.onclick = () => handleVote(candidate.id);
            candidatesList.appendChild(button);
        });
    }

    /**
     * Handles the vote transaction (Online Mode Only).
     */
    async function handleVote(candidateId) {
        if (!isOnlineMode) return; // Should not happen, but for safety

        const voteDocRef = doc(db, `artifacts/${appId}/users/${userId}/votes/user_vote`);
        const counterDocRef = doc(db, `artifacts/${appId}/public/data/counters/${candidateId}`);

        try {
            await runTransaction(db, async (transaction) => {
                // 1. Check if user has already voted
                const voteDoc = await transaction.get(voteDocRef);
                if (voteDoc.exists()) {
                    throw new Error("AlreadyVoted");
                }

                // 2. Increment the candidate's counter
                const counterDoc = await transaction.get(counterDocRef);
                const newCount = (counterDoc.exists() ? counterDoc.data().count : 0) + 1;
                
                transaction.set(counterDocRef, { count: newCount }, { merge: true });

                // 3. Mark the user as voted
                transaction.set(voteDocRef, { candidateId: candidateId, votedAt: new Date() });
            });

            // Success feedback
            voteStatus.textContent = `Voted successfully for ${candidates.find(c => c.id === candidateId).name}!`;
            voteStatus.classList.remove('hidden');
            document.querySelectorAll('.vote-button-candidate').forEach(btn => btn.disabled = true);

        } catch (e) {
            if (e.message === "AlreadyVoted") {
                voteStatus.textContent = "You have already cast your vote.";
                voteStatus.classList.remove('hidden');
            } else {
                console.error("Voting failed:", e);
                voteStatus.textContent = "Voting failed. Please try again. (Check console)";
                voteStatus.classList.remove('hidden');
            }
        }
    }

    /**
     * Listens for the user's vote status (Online Mode Only).
     */
    function listenForUserVote(voterId) {
        if (!isOnlineMode || !isAuthReady) return;
        
        const voteDocRef = doc(db, `artifacts/${appId}/users/${voterId}/votes/user_vote`);

        onSnapshot(voteDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const votedCandidate = docSnapshot.data().candidateId;
                const candidateName = candidates.find(c => c.id === votedCandidate)?.name || 'Unknown Candidate';
                
                voteStatus.textContent = `Thank you! You have already voted for: ${candidateName}.`;
                voteStatus.classList.remove('hidden');
                document.querySelectorAll('.vote-button-candidate').forEach(btn => btn.disabled = true);
            } else {
                voteStatus.textContent = "You have not voted yet. Cast your vote above.";
                voteStatus.classList.add('hidden');
                document.querySelectorAll('.vote-button-candidate').forEach(btn => btn.disabled = false);
            }
        });
    }

    /**
     * Listens for all candidate results (Online Mode Only).
     */
    function listenForResults() {
        if (!isOnlineMode || !isAuthReady) return;

        const countersColRef = collection(db, `artifacts/${appId}/public/data/counters`);
        const q = query(countersColRef);

        onSnapshot(q, (snapshot) => {
            let totalVotes = 0;
            const results = {};
            snapshot.docs.forEach(doc => {
                const count = doc.data().count || 0;
                results[doc.id] = count;
                totalVotes += count;
            });

            renderResults(results, totalVotes);
        }, (error) => {
            console.error("Error fetching live results:", error);
            resultsStatus.textContent = "Error fetching live results. Data may be delayed.";
        });
    }

    /**
     * Renders the chart view for offline mode (showing structure only).
     */
    function renderOfflineResults() {
        resultsCharts.innerHTML = '';
        resultsStatus.classList.remove('text-green-600');
        resultsStatus.classList.add('text-red-600');

        const offlineData = {
            candidateA: 10, 
            candidateB: 15, 
            candidateC: 5
        };
        const totalVotes = 30; // Mock total
        
        renderResults(offlineData, totalVotes, true);
    }


    /**
     * Renders the results (bar charts).
     */
    function renderResults(results, totalVotes, isOffline = false) {
        resultsCharts.innerHTML = '';
        const sortedResults = candidates.map(c => ({
            ...c,
            votes: results[c.id] || 0
        })).sort((a, b) => b.votes - a.votes);

        resultsStatus.textContent = isOffline 
            ? "Database is OFFLINE. Showing sample result structure." 
            : `Total Votes Cast: ${totalVotes}`;

        sortedResults.forEach((candidate, index) => {
            const percentage = totalVotes > 0 ? ((candidate.votes / totalVotes) * 100).toFixed(1) : 0;
            
            const resultItem = document.createElement('div');
            resultItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
            resultItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-semibold text-lg text-gray-700">${index + 1}. ${candidate.name}</p>
                    <p class="font-extrabold text-xl text-blue-600">${candidate.votes}</p>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div class="h-3 rounded-full bg-blue-500" style="width: ${percentage}%;"></div>
                </div>
                <p class="text-sm text-gray-500 mt-1">${percentage}% of total votes</p>
            `;
            resultsCharts.appendChild(resultItem);
        });
    }

    /**
     * Attaches event listeners for logout buttons.
     */
    function attachEventListeners() {
        loginButton.onclick = handleLogin;
        logoutButton.onclick = () => renderView('login');
        resultsLogoutButton.onclick = () => renderView('login');
    }

    // --- Application Bootstrapping ---
    document.addEventListener('DOMContentLoaded', () => {
        initFirebase();
        attachEventListeners();

        // Check the mode and render the initial view
        if (!isOnlineMode) {
            displayOfflineMode();
        } else {
            // Wait for auth to be ready, then render the login screen
            const checkAuthInterval = setInterval(() => {
                if (isAuthReady) {
                    clearInterval(checkAuthInterval);
                    renderView('login');
                }
            }, 100);
        }
    });

</script>
</body>
</html>

