<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Election System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use a pixelated/retro-style font (closer match to the image) -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        /* Base Styles for the Retro Theme */
        body {
            font-family: 'Inter', sans-serif;
            /* Using the exact dark background color from the image */
            background: #282a39; 
            min-height: 100vh;
            color: #d1d5db;
            overflow-x: hidden; 
        }
        
        /* Star Field Animation - Kept from the previous version for the background effect */
        #star-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #e0f2fe;
            border-radius: 50%;
            opacity: 0;
            box-shadow: 0 0 5px 1px #93c5fd;
            animation: twinkle linear infinite;
        }

        @keyframes twinkle {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0.5; transform: scale(1); }
        }

        /* Card and Text Styles */
        #app-container {
            position: relative;
            z-index: 10; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .glow-card {
            /* Adjusted for the smooth white card with rounded corners and shadow */
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem 2rem;
            border-radius: 1.5rem; /* Slightly more rounded */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }

        .election-title {
            /* Applied the pixel font to the main title */
            font-family: 'Press Start 2P', cursive;
            letter-spacing: 0.1rem;
            font-size: 1.5rem; /* Adjusted size for pixel font legibility */
            color: #4f46e5; /* Adjusted to a bright blue */
            text-shadow: 
                0 0 8px #93c5fd,
                0 0 15px #60a5fa; /* Stronger blue glow */
            line-height: 1.5;
        }

        .welcome-text {
            /* Styled to match the bold, blocky Welcome text in the image */
            font-family: 'Press Start 2P', cursive;
            font-size: 1.25rem;
            color: #2e303b; /* Very dark text color */
            margin-bottom: 1.5rem;
            line-height: 1;
        }
        
        /* Dashboard Specific Styles (Maintain readability for results) */
        .candidate-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            background-color: #f3f4f6;
            color: #111827;
        }
        .candidate-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px rgba(0, 0, 0, 0.15);
        }
        .vote-button {
            transition: all 0.1s ease;
        }
        .vote-button:active {
            transform: translateY(1px);
        }
        .progress-bar-container {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 1.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        /* Custom message box style (inherited from previous version) */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            transform: translateX(100%);
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-weight: 600;
            min-width: 250px;
            text-align: center;
        }
        #message-box.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }
        #message-box.success {
            background-color: #10b981;
            color: white;
        }
        #message-box.error {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <div id="star-field"></div>
    <div id="app-container">
        <!-- Login View -->
        <div id="login-view" class="glow-card text-center transition-opacity duration-500 opacity-100">
            <h1 class="election-title mb-2">
                <span style="font-size: 1.2em;">ðŸ‘‘</span> ELECTION
            </h1>
            <h2 class="welcome-text text-gray-800 mb-6">Welcome</h2>

            <p class="text-gray-600 mb-4">Please enter your unique Voting ID to proceed.</p>

            <input type="text" id="voting-id-input" placeholder="Enter Voting ID"
                class="w-full p-3 mb-6 border border-gray-300 rounded-lg text-gray-800 focus:ring-purple-400 focus:border-purple-400 transition duration-150">

            <button id="login-button" 
                style="background-color: #a78bfa;"
                class="w-full text-white font-bold py-3 rounded-lg shadow-lg hover:opacity-90 transition duration-150 transform hover:scale-[1.01] active:scale-[0.99] text-xl">
                Login
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-3 hidden">Please enter a valid ID.</p>
            
            <!-- NEW: Display Firebase Status Here -->
            <p id="firebase-status" class="mt-3 text-xs text-center font-bold text-gray-500">
                Initializing Database...
            </p>
        </div>

        <!-- Dashboard View (Hidden initially) -->
        <div id="dashboard-view" class="max-w-4xl w-full p-4 md:p-8 transition-opacity duration-500 opacity-0 hidden">
            <header class="text-center py-6 border-b border-gray-600">
                <h1 class="election-title text-4xl mb-1">
                    LIVE RESULTS
                </h1>
                <p id="total-votes" class="mt-2 text-xl text-yellow-400 font-semibold">Total Votes: 0</p>
            </header>

            <!-- Candidate Voting Section -->
            <section id="candidate-list" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6"></section>
            
            <!-- User ID Display -->
            <footer class="mt-12 pt-6 border-t border-gray-700 text-center">
                <p class="text-gray-400 text-sm">Your unique identifier (Authenticated Session):</p>
                <p id="user-id-display" class="font-mono text-xs break-all text-gray-300 mt-1">Authenticating...</p>
            </footer>
        </div>
    </div>
    
    <!-- Custom Message Box -->
    <div id="message-box" class="text-white"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, updateDoc, increment, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Configuration ---
        const CANDIDATES = [
            { id: 'steve', name: 'Steve the Builder', party: 'Block Party', color: 'bg-green-600' },
            { id: 'alex', name: 'Alex the Explorer', party: 'Adventure Coalition', color: 'bg-red-600' },
            { id: 'villager', name: 'The Trader', party: 'Emerald League', color: 'bg-blue-600' },
            { id: 'piglin', name: 'The Piglin Boss', party: 'Nether Alliance', color: 'bg-yellow-600' }
        ];

        // --- Firebase/Firestore Setup ---
        let db;
        let auth;
        let currentUserId = 'anonymous';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const COLLECTION_PATH = `artifacts/${appId}/public/data/minecraft_election_votes`;

        let isAuthReady = false;
        let isOnline = false; // NEW state flag

        // --- UI Element References ---
        const views = {
            login: document.getElementById('login-view'),
            dashboard: document.getElementById('dashboard-view')
        };
        const loginInput = document.getElementById('voting-id-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const firebaseStatusElement = document.getElementById('firebase-status'); // NEW reference

        /**
         * Switches the application's view with a fade transition.
         * @param {'login'|'dashboard'} viewName 
         */
        function switchView(viewName) {
            if (viewName === 'dashboard') {
                views.login.classList.add('opacity-0');
                // Use a short delay before hiding completely
                setTimeout(() => views.login.classList.add('hidden'), 500); 
                
                views.dashboard.classList.remove('hidden');
                setTimeout(() => {
                    views.dashboard.classList.remove('opacity-0');
                    views.dashboard.classList.add('opacity-100');
                }, 10);
                if (isAuthReady) {
                    loadCandidates(); // Start listening for data once dashboard is visible
                }
            } else {
                 views.dashboard.classList.add('opacity-0');
                 setTimeout(() => views.dashboard.classList.add('hidden'), 500);
                 
                 views.login.classList.remove('hidden');
                 setTimeout(() => {
                    views.login.classList.remove('opacity-0');
                    views.login.classList.add('opacity-100');
                 }, 10);
            }
        }

        /**
         * Simulates login based on user input.
         */
        function handleLogin() {
            if (!isOnline) {
                showMessage("Voting is disabled while offline.", 'error');
                return;
            }

            const votingId = loginInput.value.trim();
            if (votingId.length < 3) {
                loginError.classList.remove('hidden');
                return;
            }
            loginError.classList.add('hidden');
            // In a real app, this would validate the ID. Here, any valid input proceeds.
            switchView('dashboard');
        }

        /**
         * Generates and places animated stars in the background.
         */
        function createStarBackground() {
            const starField = document.getElementById('star-field');
            const numStars = 100;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                // Random position
                star.style.left = `${Math.random() * screenWidth}px`;
                star.style.top = `${Math.random() * screenHeight}px`;
                // Random size
                const size = Math.random() * 2 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                // Random animation delay/duration
                star.style.animationDelay = `${Math.random() * 5}s`;
                star.style.animationDuration = `${Math.random() * 3 + 2}s`;
                starField.appendChild(star);
            }
        }

        // --- Messaging (from previous version) ---
        function showMessage(message, type) {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = `show ${type}`; 
            setTimeout(() => {
                box.classList.remove('show');
            }, 3000);
        }

        // --- Voting and Rendering (from previous version) ---
        async function handleVote(candidateId) {
            if (!db) {
                showMessage("Database not initialized. Please wait.", 'error');
                return;
            }

            try {
                const candidateDocRef = doc(db, COLLECTION_PATH, candidateId);
                
                await updateDoc(candidateDocRef, {
                    count: increment(1)
                });

                showMessage(`Voted for ${CANDIDATES.find(c => c.id === candidateId).name}!`, 'success');
            } catch (error) {
                console.error("Error voting:", error);
                if (error.code === 'not-found' || error.message.includes('No document to update')) {
                    try {
                        const candidate = CANDIDATES.find(c => c.id === candidateId);
                        await setDoc(doc(db, COLLECTION_PATH, candidateId), {
                            name: candidate.name,
                            party: candidate.party,
                            count: 1
                        });
                        showMessage(`Voted for ${candidate.name}! (Created candidate record)`, 'success');
                    } catch (e) {
                        console.error("Error creating candidate record:", e);
                        showMessage("Error casting vote and initializing record.", 'error');
                    }
                } else {
                     showMessage("Error casting vote.", 'error');
                }
            }
        }

        function renderCandidateCard(candidate, currentVotes, totalVotes) {
            const percent = totalVotes === 0 ? 0 : (currentVotes / totalVotes) * 100;
            const progressWidth = `${percent.toFixed(2)}%`;
            const votesFormatted = currentVotes.toLocaleString();
            
            // Map Tailwind color classes to specific text colors for display
            const colorMap = {
                'bg-green-600': 'text-green-600',
                'bg-red-600': 'text-red-600',
                'bg-blue-600': 'text-blue-600',
                'bg-yellow-600': 'text-yellow-600'
            };
            const textColor = colorMap[candidate.color] || 'text-indigo-600';


            return `
                <div class="candidate-card p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900">${candidate.name}</h2>
                        <p class="text-lg font-medium text-gray-600 mb-4">${candidate.party}</p>

                        <!-- Results Display -->
                        <div class="mb-4">
                            <p class="text-2xl font-extrabold ${textColor}">${votesFormatted} <span class="text-sm font-normal text-gray-500">votes</span></p>
                            <p class="text-sm font-semibold mt-1 text-gray-700">${percent.toFixed(2)}%</p>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress-bar-container mb-6">
                            <div class="progress-bar ${candidate.color} shadow-md" style="width: ${progressWidth};"></div>
                        </div>
                    </div>
                    
                    <!-- Vote Button -->
                    <button data-id="${candidate.id}"
                        class="vote-button w-full ${candidate.color} text-white font-bold py-3 rounded-lg hover:opacity-90 transition-opacity duration-150 shadow-md transform hover:scale-[1.01] active:scale-[0.99]">
                        VOTE
                    </button>
                </div>
            `;
        }
        
        function renderDashboard(candidateData) {
            const listContainer = document.getElementById('candidate-list');
            const totalVotesElement = document.getElementById('total-votes');
            listContainer.innerHTML = ''; 

            let totalVotes = 0;
            const currentVotes = {};

            CANDIDATES.forEach(candidate => {
                const count = candidateData[candidate.id]?.count || 0;
                totalVotes += count;
                currentVotes[candidate.id] = count;
            });

            totalVotesElement.textContent = `Total Votes: ${totalVotes.toLocaleString()}`;

            CANDIDATES.forEach(candidate => {
                const count = currentVotes[candidate.id];
                listContainer.innerHTML += renderCandidateCard(candidate, count, totalVotes);
            });

            document.querySelectorAll('.vote-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const candidateId = e.currentTarget.getAttribute('data-id');
                    handleVote(candidateId);
                });
            });
        }

        async function initializeCandidateRecords() {
            for (const candidate of CANDIDATES) {
                const docRef = doc(db, COLLECTION_PATH, candidate.id);
                try {
                     await setDoc(docRef, { 
                        name: candidate.name, 
                        party: candidate.party, 
                        count: 0 
                    }, { merge: true }); 
                } catch (e) {
                    console.warn(`Could not set initial record for ${candidate.id}.`, e);
                }
            }
        }

        function loadCandidates() {
            if (!db || !isAuthReady) return;

            const collectionRef = collection(db, COLLECTION_PATH);
            
            onSnapshot(collectionRef, (snapshot) => {
                const candidateData = {};
                snapshot.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    candidateData[docSnapshot.id] = { 
                        name: data.name, 
                        party: data.party, 
                        count: data.count || 0 
                    };
                });
                renderDashboard(candidateData);
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                showMessage("Real-time results connection lost.", 'error');
            });
        }

        // --- Initialization ---
        async function setupFirebase() {
            firebaseStatusElement.textContent = 'Checking configuration...';
            loginButton.disabled = true;

            if (Object.keys(firebaseConfig).length === 0) {
                firebaseStatusElement.textContent = 'Database connection error. Voting is disabled. (Offline Mode)';
                firebaseStatusElement.classList.add('text-red-500');
                isOnline = false;
                return;
            }

            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                firebaseStatusElement.textContent = 'Authenticating user...';

                await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); 
                        if (user) {
                            currentUserId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                    currentUserId = userCredential.user.uid;
                                } else {
                                    const userCredential = await signInAnonymously(auth);
                                    currentUserId = userCredential.user.uid;
                                }
                            } catch (error) {
                                console.error("Firebase Auth Error:", error);
                                // Fallback to a random ID if auth fails completely
                                currentUserId = crypto.randomUUID(); 
                            }
                        }
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        await initializeCandidateRecords();
                        resolve();
                    }, reject);
                });
                
                // Success: Update UI
                isOnline = true;
                firebaseStatusElement.textContent = 'Online. Ready to Vote.';
                firebaseStatusElement.classList.remove('text-red-500', 'text-gray-500');
                firebaseStatusElement.classList.add('text-green-500');
                loginButton.disabled = false;


            } catch (error) {
                console.error("Global Firebase Setup Error:", error);
                // Failure: Update UI to show the specific error if possible
                isOnline = false;
                document.getElementById('user-id-display').textContent = `Setup Failed: ${error.message}`;
                firebaseStatusElement.textContent = `Database connection error: ${error.message.substring(0, 50)}... (Offline Mode)`;
                firebaseStatusElement.classList.remove('text-gray-500');
                firebaseStatusElement.classList.add('text-red-500');
            }
        }

        window.onload = () => {
            createStarBackground();
            setupFirebase();
            
            // Attach event listener for the login button
            loginButton.addEventListener('click', handleLogin);
            
            // Allow pressing enter to log in
            loginInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        };
    </script>
</body>
</html>

